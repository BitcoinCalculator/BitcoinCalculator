
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Landlord’s Best Friend — 50-Year Real Estate & Retirement Simulator</title>

<style>
  /* EXACT THEME FEEL (matches your other pages) */
  * { box-sizing: border-box; }
  body{
    font-family:"Helvetica Neue", Arial, sans-serif;
    background:#f9fafb;
    color:#1a1a1a;
    margin:0;
  }
  header{
    background:#111;
    color:#f9fafb;
    padding:1.6rem 1rem;
    text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,.3);
  }
  header h1{ margin:0 0 .25rem; font-size:2rem; }
  header p{ margin:0; opacity:.9; }

  .page-nav{
    margin-top: 12px;
    display:flex;
    justify-content:center;
  }
  .page-nav ul{
    list-style:none;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:1.2rem;
    padding:0;
    margin:0;
  }
  .page-nav a{
    text-decoration:none;
    font-weight:bold;
    color:#f7931a; /* Home button orange */
    transition:color .2s;
    font-size:clamp(0.9rem, 2.5vw, 1.1rem);
  }
  .page-nav a:hover{ color:#ffffff; }

  main{ max-width:1100px; margin:2rem auto; padding:0 20px; }

  .calculator{
    background:#fff;
    padding:20px;
    border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,.08);
  }

  .section-title{
    margin: 18px 0 10px;
    font-size: 1.1rem;
    font-weight: 800;
    color:#111;
  }

  .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:14px; }
  .form-group{ display:flex; flex-direction:column; }
  label{ font-weight:600; color:#333; margin-bottom:6px; }
  input[type="number"], input[type="text"], select{
    padding:10px;
    border:1px solid #ccc;
    border-radius:8px;
    font-size:14px;
    background:#fff;
  }

  .hint{ font-size:12.5px; color:#666; margin-top:6px; line-height:1.35; }
  .subtle{ font-size:13px; color:#666; margin-top:8px; }

  .btn-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  button{
    border:0;
    padding:12px 16px;
    border-radius:8px;
    cursor:pointer;
    font-size:15px;
    font-weight:700;
  }
  #addPropertyBtn{ background:#111; color:#fff; }
  #addPropertyBtn:hover{ background:#2a2a2a; }
  #calcBtn{ background:#f7931a; color:#fff; flex:1; }
  #calcBtn:hover{ background:#e07c12; }
  #exportBtn{ background:#6c757d; color:#fff; display:none; }
  #exportBtn:hover{ background:#5a6268; }
  #chartBtn{ background:#007bff; color:#fff; display:none; }
  #chartBtn:hover{ background:#0056b3; }

  #error{ color:#c62828; margin-top:12px; }
  #result{ display:none; background:#e9ecef; padding:14px; border-radius:8px; margin-top:14px; }

  .property-card{
    margin-top:14px;
    padding:14px;
    border:1px solid #eee;
    border-radius:12px;
    background:#fff;
    box-shadow:0 1px 6px rgba(0,0,0,.04);
  }
  .property-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }
  .property-head strong{ font-size:1rem; }
  .remove-btn{
    background:#dc3545;
    color:#fff;
    padding:8px 10px;
    border-radius:8px;
    font-size:13px;
    font-weight:800;
  }
  .remove-btn:hover{ background:#b02a37; }

  table{ width:100%; border-collapse:collapse; margin-top:18px; background:#fff; }
  th, td{ text-align:right; padding:8px; border-bottom:1px solid #eee; white-space:nowrap; }
  th{ background:#f8f9fa; position:sticky; top:0; z-index:1; }
  td:first-child, th:first-child{ text-align:left; }

  /* Highlight Net Worth column (light blue) */
  th.networth-col{
    background:#9fd0ff !important;
    color:#0b2a3f !important;
  }
  td.networth-col{
    background:#eaf5ff;
    font-weight:800;
  }

  /* Optional: highlight BTC column header a bit (matches your style) */
  th.btc-col{
    background:#f7931a !important;
    color:#fff !important;
  }
  td.btc-col{
    background:#fff3e0;
    font-weight:800;
  }

  /* Divider row for table sections */
  tr.section-divider td{
    background:#efe6ff;
    color:#3b245a;
    font-weight:900;
    text-align:center !important;
    border-bottom:1px solid #d9c6ff;
  }

  #chartContainer{ display:none; margin-top:18px; }
  canvas{ max-width:100%; }

  footer{ text-align:center; padding:1.5rem; color:#666; }
</style>
</head>

<body>
<header>
  <h1>Landlord’s Best Friend</h1>
  <p>Simulate property cashflow, equity growth, and retirement viability — year by year.</p>
  <nav class="page-nav">
    <ul>
      <li><a href="index.html">← Home</a></li>
    </ul>
  </nav>
</header>

<main>
  <div class="calculator">

    <div class="section-title">Personal & Planning Inputs</div>
    <div class="grid">
      <div class="form-group">
        <label for="age">Current Age</label>
        <input type="number" id="age" min="0" max="100" step="1" required>
      </div>
      <div class="form-group">
        <label for="lifeExpectancy">Plan To Age (life expectancy)</label>
        <input type="number" id="lifeExpectancy" min="60" max="120" step="1" value="95" required>
      </div>

      <div class="form-group">
        <label for="otherIncome">Other Yearly Income ($)</label>
        <input type="number" id="otherIncome" min="0" step="100" value="0">
        <div class="hint">Example: job income, pension, side business. (Rental income is handled inside properties.)</div>
      </div>

      <div class="form-group">
        <label for="retirementSpending">Desired Annual Spending ($, today’s dollars)</label>
        <input type="number" id="retirementSpending" min="0" step="100" value="100000">
      </div>

      <div class="form-group">
        <label for="inflationRate">Inflation Rate (%)</label>
        <input type="number" id="inflationRate" min="0" max="20" step="0.1" value="3">
      </div>

      <div class="form-group">
        <label for="rentGrowth">Rent Growth Rate (%)</label>
        <input type="number" id="rentGrowth" min="-20" max="50" step="0.1" value="3">
        <div class="hint">Default matches inflation. You can change it.</div>
      </div>

      <div class="form-group">
        <label for="propertyAppreciation">Real Estate Appreciation CAGR (%)</label>
        <input type="number" id="propertyAppreciation" min="-20" max="50" step="0.1" value="2">
      </div>

      <div class="form-group">
        <label for="vacancyRate">Vacancy / Downtime (%)</label>
        <input type="number" id="vacancyRate" min="0" max="50" step="0.1" value="5">
        <div class="hint">Applies to rentals (reduces gross rent). For short-term rentals, occupancy already matters too.</div>
      </div>
    </div>

    <div class="section-title">Non-Property Assets</div>
    <div class="grid">
      <div class="form-group">
        <label for="bank">Cash / Bank ($)</label>
        <input type="number" id="bank" min="0" step="100" value="0">
      </div>
      <div class="form-group">
        <label for="bankCagr">Cash Growth (%)</label>
        <input type="number" id="bankCagr" min="-10" max="20" step="0.1" value="0">
      </div>

      <div class="form-group">
        <label for="stocks">Stocks / Brokerage ($)</label>
        <input type="number" id="stocks" min="0" step="100" value="0">
      </div>
      <div class="form-group">
        <label for="stocksCagr">Stocks CAGR (%)</label>
        <input type="number" id="stocksCagr" min="-50" max="50" step="0.1" value="7">
      </div>

      <div class="form-group">
        <label for="k401">401k / Retirement Accounts ($)</label>
        <input type="number" id="k401" min="0" step="100" value="0">
      </div>
      <div class="form-group">
        <label for="k401Cagr">401k CAGR (%)</label>
        <input type="number" id="k401Cagr" min="-50" max="50" step="0.1" value="7">
      </div>

      <div class="form-group">
        <label for="otherAssets">Other Assets ($)</label>
        <input type="number" id="otherAssets" min="0" step="100" value="0">
      </div>
      <div class="form-group">
        <label for="otherAssetsCagr">Other Assets CAGR (%)</label>
        <input type="number" id="otherAssetsCagr" min="-50" max="50" step="0.1" value="3">
      </div>
    </div>

    <div class="section-title">Bitcoin “What-If” Comparison</div>
    <div class="grid">
      <div class="form-group">
        <label for="btcCagr">Bitcoin CAGR (%)</label>
        <input type="number" id="btcCagr" min="-100" max="500" step="0.1" value="20">
        <div class="hint">
          CAGR = “Compound Annual Growth Rate”. Example: 20% means multiplying by 1.20 each year on average.
          This is a simple model — real life is volatile.
        </div>
      </div>

      <div class="form-group">
        <label for="btcStartAmount">Bitcoin Starting Amount ($)</label>
        <input type="number" id="btcStartAmount" min="0" step="100" value="0">
        <div class="hint">If you leave this at 0, the calculator auto-fills it as (cash + stocks + 401k + other + total property equity).</div>
      </div>
    </div>

    <div class="section-title">Properties</div>
    <div class="subtle">
      Add as many properties as you want. Property #1 is the only one that asks “Primary Residence?”.
      Each property can be a rental or not. Rentals can be long-term or short-term.
    </div>

    <div id="propertiesContainer"></div>

    <div class="btn-row">
      <button id="addPropertyBtn" type="button">+ Add Another Property</button>
      <button id="calcBtn" type="button">Calculate (50-Year Projection)</button>
      <button id="chartBtn" type="button">Show Chart</button>
      <button id="exportBtn" type="button">Export Table (CSV)</button>
    </div>

    <div id="error"></div>
    <div id="result"></div>

    <div id="chartContainer">
      <canvas id="netWorthChart"></canvas>
    </div>

    <div id="tableContainer"></div>
    <div id="btcTableContainer"></div>
    <div id="propertySummaryContainer"></div>
  </div>
</main>

<footer>
  <p>&copy; 2026 The Bitcoiner's Calculators</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
/* ===========================
   PROPERTY FORM BUILDER
=========================== */
let propertyCount = 0;
let chartInstance = null;
let lastProjection = null;

const propertiesContainer = document.getElementById('propertiesContainer');

/* ✅ FIXED addProperty() (buttons will work) */
function addProperty() {
  propertyCount += 1;
  const idx = propertyCount;

  const card = document.createElement('div');
  card.className = 'property-card';
  card.dataset.idx = idx;

  const head = document.createElement('div');
  head.className = 'property-head';
  head.innerHTML = `<strong>Property ${idx}</strong>`;

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.className = 'remove-btn';
  removeBtn.textContent = 'Remove';
  removeBtn.addEventListener('click', () => card.remove());

  head.appendChild(removeBtn);
  card.appendChild(head);

  const grid = document.createElement('div');
  grid.className = 'grid';

  // Name (optional)
  grid.appendChild(makeInput(`p${idx}_name`, 'Nickname (optional)', 'text', '', { placeholder: 'e.g., Duplex in Riverside' }));

  grid.appendChild(makeInput(`p${idx}_value`, 'Current Property Value ($)', 'number', 0, { min:0, step:100 }));
  grid.appendChild(makeInput(`p${idx}_equity`, 'Current Equity ($)', 'number', 0, {
    min:0, step:100,
    hint:'Equity = value - mortgage balance (if you know mortgage balance instead, set equity = value - balance).'
  }));

  grid.appendChild(makeInput(`p${idx}_rate`, 'Mortgage Interest Rate (%)', 'number', 6.5, { step:0.01, hint:'If no mortgage, set rate=0, payment=0, balance via equity.' }));
  grid.appendChild(makeInput(`p${idx}_payment`, 'Monthly Mortgage Payment ($)', 'number', 0, { min:0, step:10 }));
  grid.appendChild(makeInput(`p${idx}_extra`, 'Extra Principal Paid Monthly ($)', 'number', 0, { min:0, step:10, hint:'Optional. Helps pay off sooner and saves interest.' }));
  grid.appendChild(makeInput(`p${idx}_yearsRemaining`, 'Years Remaining on Mortgage', 'number', 30, { min:0, max:50, step:1 }));

  if (idx === 1) {
    const prim = makeSelect(`p${idx}_primary`, 'Is this your Primary Residence?', [
      { value:'no', text:'No' },
      { value:'yes', text:'Yes' }
    ], 'no');
    grid.appendChild(prim.wrapper);
  } else {
    const primDummy = makeSelect(`p${idx}_primary_dummy`, 'Primary Residence (only asked on Property 1)', [
      { value:'na', text:'N/A' }
    ], 'na', true);
    grid.appendChild(primDummy.wrapper);
  }

  // Rental toggle for all properties
  const rentSelect = makeSelect(`p${idx}_rented`, 'Is this property rented?', [
    { value:'no', text:'No' },
    { value:'yes', text:'Yes' }
  ], 'no');
  grid.appendChild(rentSelect.wrapper);

  // Rental fields container
  const rentalFields = document.createElement('div');
  rentalFields.className = 'grid';
  rentalFields.style.marginTop = '14px';
  rentalFields.style.display = 'none';
  rentalFields.id = `p${idx}_rentalFields`;

  // Rental type
  const rentalType = makeSelect(`p${idx}_rentalType`, 'Rental Type', [
    { value:'long', text:'Long-Term Rental (monthly rent)' },
    { value:'short', text:'Short-Term Rental (nightly + occupancy)' }
  ], 'long');
  rentalFields.appendChild(rentalType.wrapper);

  // Long-term income
  rentalFields.appendChild(makeInput(`p${idx}_monthlyRent`, 'Monthly Rent ($)', 'number', 0, { min:0, step:10 }));

  // Short-term income inputs
  rentalFields.appendChild(makeInput(`p${idx}_nightlyRate`, 'Avg Nightly Rate ($)', 'number', 0, { min:0, step:5 }));
  rentalFields.appendChild(makeInput(`p${idx}_occupancy`, 'Occupancy (%)', 'number', 60, { min:0, max:100, step:0.1, hint:'For short-term rentals: % of nights booked.' }));
  rentalFields.appendChild(makeInput(`p${idx}_bookingsPerMonth`, 'Avg Bookings / Month', 'number', 10, { min:0, step:1 }));
  rentalFields.appendChild(makeInput(`p${idx}_cleaningFee`, 'Cleaning Fee (per booking) ($)', 'number', 0, { min:0, step:1 }));

  // Operating costs
  rentalFields.appendChild(makeInput(`p${idx}_hoa`, 'HOA (monthly) ($)', 'number', 0, { min:0, step:10 }));
  rentalFields.appendChild(makeInput(`p${idx}_insurance`, 'Insurance (monthly) ($)', 'number', 0, { min:0, step:10 }));
  rentalFields.appendChild(makeInput(`p${idx}_utilities`, 'Utilities Paid by Owner (monthly) ($)', 'number', 0, { min:0, step:10 }));
  rentalFields.appendChild(makeInput(`p${idx}_otherMonthly`, 'Other Fixed Monthly Costs ($)', 'number', 0, { min:0, step:10, hint:'Gardener, pest control, alarm, etc.' }));

  rentalFields.appendChild(makeInput(`p${idx}_taxRate`, 'Property Tax Rate (%)', 'number', 1.1, { min:0, max:5, step:0.01, hint:'Annual tax = (property value × tax rate).' }));
  rentalFields.appendChild(makeInput(`p${idx}_maintenancePct`, 'Maintenance Reserve (% of value / year)', 'number', 1.0, { min:0, max:10, step:0.1, hint:'Common planning range: 0.5%–2% of value per year.' }));
  rentalFields.appendChild(makeInput(`p${idx}_managementPct`, 'Property Management (% of rent)', 'number', 0, { min:0, max:30, step:0.1, hint:'If you self-manage, set to 0.' }));

  card.appendChild(grid);
  card.appendChild(rentalFields);

  // Show/hide rentalFields based on rented
  rentSelect.select.addEventListener('change', () => {
    rentalFields.style.display = (rentSelect.select.value === 'yes') ? 'grid' : 'none';
    toggleRentalTypeFields(idx);
  });

  rentalType.select.addEventListener('change', () => toggleRentalTypeFields(idx));

  propertiesContainer.appendChild(card);

  // Ensure correct default visibility for long vs short fields
  toggleRentalTypeFields(idx);
}

function toggleRentalTypeFields(idx){
  const rented = document.getElementById(`p${idx}_rented`)?.value === 'yes';
  const type = document.getElementById(`p${idx}_rentalType`)?.value || 'long';

  const showLong = rented && type === 'long';
  const showShort = rented && type === 'short';

  setDisplay(`p${idx}_monthlyRent`, showLong);

  setDisplay(`p${idx}_nightlyRate`, showShort);
  setDisplay(`p${idx}_occupancy`, showShort);
  setDisplay(`p${idx}_bookingsPerMonth`, showShort);
  setDisplay(`p${idx}_cleaningFee`, showShort);
}

function setDisplay(inputId, show){
  const el = document.getElementById(inputId);
  if(!el) return;
  const wrapper = el.closest('.form-group');
  if(wrapper) wrapper.style.display = show ? 'flex' : 'none';
}

function makeInput(id, labelText, type, defaultVal, opts = {}) {
  const wrapper = document.createElement('div');
  wrapper.className = 'form-group';

  const label = document.createElement('label');
  label.setAttribute('for', id);
  label.textContent = labelText;

  const input = document.createElement('input');
  input.type = type;
  input.id = id;
  input.value = defaultVal;

  if (opts.placeholder) input.placeholder = opts.placeholder;
  if (opts.min !== undefined) input.min = opts.min;
  if (opts.max !== undefined) input.max = opts.max;
  if (opts.step !== undefined) input.step = opts.step;

  wrapper.appendChild(label);
  wrapper.appendChild(input);

  if (opts.hint) {
    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.textContent = opts.hint;
    wrapper.appendChild(hint);
  }

  return wrapper;
}

function makeSelect(id, labelText, options, defaultVal, disabled=false) {
  const wrapper = document.createElement('div');
  wrapper.className = 'form-group';

  const label = document.createElement('label');
  label.setAttribute('for', id);
  label.textContent = labelText;

  const select = document.createElement('select');
  select.id = id;
  if (disabled) select.disabled = true;

  options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.value;
    opt.textContent = o.text;
    select.appendChild(opt);
  });
  select.value = defaultVal;

  wrapper.appendChild(label);
  wrapper.appendChild(select);

  return { wrapper, select };
}

/* Start with one property by default */
addProperty();
toggleRentalTypeFields(1);

document.getElementById('addPropertyBtn').addEventListener('click', () => {
  addProperty();
});

/* ===========================
   CALCULATIONS
=========================== */

document.getElementById('calcBtn').addEventListener('click', () => run());
document.getElementById('exportBtn').addEventListener('click', () => exportCSV(lastProjection));
document.getElementById('chartBtn').addEventListener('click', () => drawChart(lastProjection));

function vNum(id){
  const el = document.getElementById(id);
  if(!el) return NaN;
  const x = (el.value || '').toString().trim();
  return x === '' ? NaN : parseFloat(x);
}
function vText(id){
  const el = document.getElementById(id);
  return el ? (el.value || '').toString().trim() : '';
}
function vSel(id){
  const el = document.getElementById(id);
  return el ? el.value : '';
}

function run(){
  const errorDiv = document.getElementById('error');
  const resultDiv = document.getElementById('result');
  const exportBtn = document.getElementById('exportBtn');
  const chartBtn = document.getElementById('chartBtn');
  const tableContainer = document.getElementById('tableContainer');
  const btcTableContainer = document.getElementById('btcTableContainer');
  const propertySummaryContainer = document.getElementById('propertySummaryContainer');
  const chartContainer = document.getElementById('chartContainer');

  errorDiv.textContent = '';
  resultDiv.style.display = 'none';
  exportBtn.style.display = 'none';
  chartBtn.style.display = 'none';
  tableContainer.innerHTML = '';
  btcTableContainer.innerHTML = '';
  propertySummaryContainer.innerHTML = '';
  chartContainer.style.display = 'none';
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  const inputs = getInputsAndProperties();
  if (inputs.errors.length){
    errorDiv.textContent = inputs.errors.join(' ');
    return;
  }

  // Auto-fill btcStartAmount if user left at 0
  if (inputs.btcStartAmount <= 0) {
    const totalEquity = inputs.properties.reduce((s,p) => s + Math.max(0, p.equity), 0);
    inputs.btcStartAmount = inputs.bank + inputs.stocks + inputs.k401 + inputs.otherAssets + totalEquity;
  }

  const projection = simulate(inputs);
  lastProjection = projection;

  const firstRetiredYear = projection.path.find(r => r.surplus >= 0);

  resultDiv.style.display = 'block';
  if (firstRetiredYear) {
    resultDiv.innerHTML = `
      ✅ First year your modeled cashflow + other income meets spending: <strong>${firstRetiredYear.year}</strong>
      (Age <strong>${firstRetiredYear.age}</strong>).<br/>
      This uses your inflation + rent growth assumptions and current mortgages.
    `;
  } else {
    resultDiv.innerHTML = `
      ⚠️ Under these assumptions, cashflow + other income never fully meets spending through age <strong>${inputs.lifeExpectancy}</strong>.
      You may need higher rent, lower spending, refinancing, or more assets.
    `;
  }

  renderMainTable(projection.path, inputs, tableContainer);
  renderBitcoinTable(projection.btcPath, btcTableContainer);
  renderPropertyYear1Summary(projection.propertyYear1, propertySummaryContainer);

  exportBtn.style.display = 'inline-block';
  chartBtn.style.display = 'inline-block';

  drawChart(projection);
}

function getInputsAndProperties(){
  const errors = [];

  const age = vNum('age');
  const lifeExpectancy = vNum('lifeExpectancy');

  const otherIncome = vNum('otherIncome');
  const retirementSpending = vNum('retirementSpending');

  const inflationRate = vNum('inflationRate')/100;
  const rentGrowth = vNum('rentGrowth')/100;
  const propertyAppreciation = vNum('propertyAppreciation')/100;
  const vacancyRate = vNum('vacancyRate')/100;

  const bank = vNum('bank');
  const bankCagr = vNum('bankCagr')/100;
  const stocks = vNum('stocks');
  const stocksCagr = vNum('stocksCagr')/100;
  const k401 = vNum('k401');
  const k401Cagr = vNum('k401Cagr')/100;
  const otherAssets = vNum('otherAssets');
  const otherAssetsCagr = vNum('otherAssetsCagr')/100;

  let btcStartAmount = vNum('btcStartAmount');
  const btcCagr = vNum('btcCagr')/100;

  if (isNaN(age) || age < 0 || age > 100) errors.push('Age must be 0–100.');
  if (isNaN(lifeExpectancy) || lifeExpectancy <= age) errors.push('Life expectancy must exceed current age.');

  const mustNums = [
    ['Other yearly income', otherIncome],
    ['Desired spending', retirementSpending],
    ['Inflation rate', inflationRate],
    ['Rent growth', rentGrowth],
    ['Property appreciation', propertyAppreciation],
    ['Vacancy rate', vacancyRate],
    ['Cash/bank', bank],
    ['Cash CAGR', bankCagr],
    ['Stocks', stocks],
    ['Stocks CAGR', stocksCagr],
    ['401k', k401],
    ['401k CAGR', k401Cagr],
    ['Other assets', otherAssets],
    ['Other assets CAGR', otherAssetsCagr],
    ['Bitcoin CAGR', btcCagr]
  ];
  mustNums.forEach(([name,val]) => { if (isNaN(val)) errors.push(`${name} is required.`); });

  const cards = Array.from(document.querySelectorAll('.property-card'));
  if (!cards.length) errors.push('Please add at least 1 property.');

  const properties = [];
  cards.forEach((card, orderIdx) => {
    const idx = card.dataset.idx;
    const name = vText(`p${idx}_name`) || `Property ${orderIdx+1}`;

    const value = vNum(`p${idx}_value`);
    const equity = vNum(`p${idx}_equity`);
    const rate = vNum(`p${idx}_rate`)/100;
    const payment = vNum(`p${idx}_payment`);
    const extra = vNum(`p${idx}_extra`);
    const yearsRemaining = vNum(`p${idx}_yearsRemaining`);
    const primary = (orderIdx===0) ? (vSel(`p${idx}_primary`) === 'yes') : false;

    const rented = vSel(`p${idx}_rented`) === 'yes';
    const rentalType = rented ? vSel(`p${idx}_rentalType`) : 'none';

    const monthlyRent = rented ? vNum(`p${idx}_monthlyRent`) : 0;
    const nightlyRate = rented ? vNum(`p${idx}_nightlyRate`) : 0;
    const occupancy = rented ? vNum(`p${idx}_occupancy`)/100 : 0;
    const bookingsPerMonth = rented ? vNum(`p${idx}_bookingsPerMonth`) : 0;
    const cleaningFee = rented ? vNum(`p${idx}_cleaningFee`) : 0;

    const hoa = (vNum(`p${idx}_hoa`) || 0);
    const insurance = (vNum(`p${idx}_insurance`) || 0);
    const utilities = (vNum(`p${idx}_utilities`) || 0);
    const otherMonthly = (vNum(`p${idx}_otherMonthly`) || 0);

    const taxRate = (vNum(`p${idx}_taxRate`)/100 || 0.011);
    const maintenancePct = (vNum(`p${idx}_maintenancePct`)/100 || 0.01);
    const managementPct = (vNum(`p${idx}_managementPct`)/100 || 0);

    if (isNaN(value) || value < 0) errors.push(`${name}: property value must be ≥ 0.`);
    if (isNaN(equity) || equity < 0) errors.push(`${name}: equity must be ≥ 0.`);
    if (isNaN(rate) || rate < 0) errors.push(`${name}: interest rate is required.`);
    if (isNaN(payment) || payment < 0) errors.push(`${name}: monthly payment must be ≥ 0.`);
    if (isNaN(extra) || extra < 0) errors.push(`${name}: extra payment must be ≥ 0.`);
    if (isNaN(yearsRemaining) || yearsRemaining < 0 || yearsRemaining > 50) errors.push(`${name}: years remaining must be 0–50.`);

    if (rented) {
      if (rentalType === 'long') {
        if (isNaN(monthlyRent) || monthlyRent < 0) errors.push(`${name}: monthly rent must be ≥ 0.`);
      } else if (rentalType === 'short') {
        const reqs = [
          ['nightly rate', nightlyRate],
          ['occupancy', occupancy],
          ['bookings/month', bookingsPerMonth],
          ['cleaning fee', cleaningFee]
        ];
        reqs.forEach(([lab,val]) => { if (isNaN(val) || val < 0) errors.push(`${name}: ${lab} must be valid.`); });
      }
      const ops = [hoa, insurance, utilities, otherMonthly, taxRate, maintenancePct, managementPct];
      if (ops.some(x => isNaN(x))) errors.push(`${name}: rental expense inputs are incomplete.`);
    }

    const mortgageBalance = Math.max(0, value - equity);

    properties.push({
      uiIdx: orderIdx+1,
      name,
      value,
      equity,
      mortgageBalance,
      rate,
      payment,
      extra,
      yearsRemaining,
      primary,
      rented,
      rentalType,
      monthlyRent: monthlyRent || 0,
      nightlyRate: nightlyRate || 0,
      occupancy: occupancy || 0,
      bookingsPerMonth: bookingsPerMonth || 0,
      cleaningFee: cleaningFee || 0,
      hoa: hoa || 0,
      insurance: insurance || 0,
      utilities: utilities || 0,
      otherMonthly: otherMonthly || 0,
      taxRate: taxRate || 0.011,
      maintenancePct: maintenancePct || 0.01,
      managementPct: managementPct || 0
    });
  });

  if (isNaN(btcStartAmount) || btcStartAmount < 0) btcStartAmount = 0;

  return {
    errors,
    age,
    lifeExpectancy,
    otherIncome,
    retirementSpending,
    inflationRate,
    rentGrowth,
    propertyAppreciation,
    vacancyRate,
    bank, bankCagr,
    stocks, stocksCagr,
    k401, k401Cagr,
    otherAssets, otherAssetsCagr,
    btcStartAmount,
    btcCagr,
    properties
  };
}

function amortizeOneYear(balance, annualRate, monthlyPayment, extraMonthly){
  let b = balance;
  const r = annualRate / 12;
  let interestPaid = 0;
  let principalPaid = 0;
  let months = 0;

  for (let m=0; m<12; m++){
    if (b <= 0) break;
    months++;

    const interest = b * r;
    interestPaid += interest;

    const pay = Math.max(0, monthlyPayment + extraMonthly);
    const principal = pay - interest;

    if (principal <= 0) {
      b = b + (interest - pay);
      continue;
    }

    const actualPrincipal = Math.min(principal, b);
    principalPaid += actualPrincipal;
    b -= actualPrincipal;
  }

  return { endBalance: b, interestPaid, principalPaid, monthsPaid: months };
}

function simulate(inputs){
  const startYear = new Date().getFullYear();
  const years = Math.max(0, Math.floor(inputs.lifeExpectancy - inputs.age));

  const props = inputs.properties.map(p => ({
    name: p.name,
    value: p.value,
    balance: p.mortgageBalance,
    rate: p.rate,
    payment: p.payment,
    extra: p.extra,
    yearsRemaining: p.yearsRemaining,
    primary: p.primary,
    rented: p.rented,
    rentalType: p.rentalType,
    monthlyRent: p.monthlyRent,
    nightlyRate: p.nightlyRate,
    occupancy: p.occupancy,
    bookingsPerMonth: p.bookingsPerMonth,
    cleaningFee: p.cleaningFee,
    hoa: p.hoa,
    insurance: p.insurance,
    utilities: p.utilities,
    otherMonthly: p.otherMonthly,
    taxRate: p.taxRate,
    maintenancePct: p.maintenancePct,
    managementPct: p.managementPct,
    payoffYear: null
  }));

  let bank = inputs.bank;
  let stocks = inputs.stocks;
  let k401 = inputs.k401;
  let other = inputs.otherAssets;

  let btcVal = inputs.btcStartAmount;

  const path = [];
  const btcPath = [];

  let propertyYear1 = null;

  for (let y=0; y<=years; y++){
    const year = startYear + y;
    const age = inputs.age + y;

    const spending = inputs.retirementSpending * Math.pow(1 + inputs.inflationRate, y);
    const otherIncome = inputs.otherIncome;

    let totalPropValue = 0;
    let totalBalance = 0;
    let totalEquity = 0;

    let totalGrossIncome = 0;
    let totalOperatingExp = 0;
    let totalMortgagePaid = 0;
    let totalNetCashflow = 0;

    const perProp = [];

    props.forEach((p) => {
      let grossIncome = 0;
      if (p.rented) {
        if (p.rentalType === 'long') {
          const rentThisYear = p.monthlyRent * Math.pow(1 + inputs.rentGrowth, y);
          grossIncome = rentThisYear * 12;
          grossIncome *= (1 - inputs.vacancyRate);
        } else if (p.rentalType === 'short') {
          const nightly = p.nightlyRate * Math.pow(1 + inputs.rentGrowth, y);
          const occ = Math.max(0, Math.min(1, p.occupancy));
          grossIncome = nightly * 365 * occ;
          grossIncome *= (1 - (inputs.vacancyRate/2));
        }
      }

      const tax = p.value * p.taxRate;
      const insurance = p.insurance * 12;
      const hoa = p.hoa * 12;
      const utilities = p.utilities * 12;
      const otherFixed = p.otherMonthly * 12;

      const maintenance = p.value * p.maintenancePct;
      const management = p.rented ? (grossIncome * p.managementPct) : 0;

      const cleaning = (p.rented && p.rentalType === 'short')
        ? (p.bookingsPerMonth * 12 * p.cleaningFee)
        : 0;

      const operatingExp = tax + insurance + hoa + utilities + otherFixed + maintenance + management + cleaning;

      let mortPaid = 0;

      if (p.balance > 0 && (p.payment + p.extra) > 0) {
        const res = amortizeOneYear(p.balance, p.rate, p.payment, p.extra);
        p.balance = res.endBalance;

        mortPaid = (p.payment + p.extra) * res.monthsPaid;
        const approxPaid = res.interestPaid + res.principalPaid;
        mortPaid = Math.min(mortPaid, approxPaid + 5);

        if (p.balance <= 0 && p.payoffYear === null) {
          p.payoffYear = year;
        }
      }

      const totalExp = operatingExp + mortPaid;
      const netCashflow = grossIncome - totalExp;

      totalPropValue += p.value;
      totalBalance += p.balance;
      totalEquity += Math.max(0, p.value - p.balance);

      totalGrossIncome += grossIncome;
      totalOperatingExp += operatingExp;
      totalMortgagePaid += mortPaid;
      totalNetCashflow += netCashflow;

      perProp.push({
        name: p.name,
        value: p.value,
        balance: p.balance,
        equity: Math.max(0, p.value - p.balance),
        grossIncome,
        operatingExp,
        mortgagePaid: mortPaid,
        netCashflow
      });

      p.value *= (1 + inputs.propertyAppreciation);
    });

    const liquidTotal = bank + stocks + k401 + other;
    const netWorth = liquidTotal + totalPropValue - totalBalance;
    const surplus = (otherIncome + totalNetCashflow) - spending;

    path.push({
      year,
      age,
      spending: round2(spending),
      otherIncome: round2(otherIncome),
      totalGrossIncome: round2(totalGrossIncome),
      totalOperatingExp: round2(totalOperatingExp),
      totalMortgagePaid: round2(totalMortgagePaid),
      totalNetCashflow: round2(totalNetCashflow),
      surplus: round2(surplus),

      bank: round2(bank),
      stocks: round2(stocks),
      k401: round2(k401),
      other: round2(other),

      totalPropValue: round2(totalPropValue),
      totalMortgageBalance: round2(totalBalance),
      totalEquity: round2(totalEquity),

      netWorth: round2(netWorth),
      perProp
    });

    if (y === 0) {
      propertyYear1 = perProp.map(p => ({
        name: p.name,
        value: p.value,
        balance: p.balance,
        equity: p.equity,
        grossIncome: p.grossIncome,
        operatingExp: p.operatingExp,
        mortgagePaid: p.mortgagePaid,
        netCashflow: p.netCashflow
      }));
    }

    btcPath.push({
      year,
      age,
      btcValue: round2(btcVal)
    });

    bank *= (1 + inputs.bankCagr);
    stocks *= (1 + inputs.stocksCagr);
    k401 *= (1 + inputs.k401Cagr);
    other *= (1 + inputs.otherAssetsCagr);

    btcVal *= (1 + inputs.btcCagr);
  }

  return { path, btcPath, propertyYear1 };
}

function round2(x){
  return Math.round((x + Number.EPSILON) * 100) / 100;
}

function renderMainTable(path, inputs, container){
  if(!path || !path.length) return;

  const propNames = path[0].perProp.map(p => p.name);

  const baseCols = [
    ['Year','year'],
    ['Age','age'],
    ['Net Worth ($)','netWorth'],
    ['Total Prop Value ($)','totalPropValue'],
    ['Total Mortgage ($)','totalMortgageBalance'],
    ['Total Equity ($)','totalEquity'],
    ['Rental Gross ($)','totalGrossIncome'],
    ['OpEx ($)','totalOperatingExp'],
    ['Mortgage Paid ($)','totalMortgagePaid'],
    ['Net Rental CF ($)','totalNetCashflow'],
    ['Other Income ($)','otherIncome'],
    ['Spending ($)','spending'],
    ['Surplus / Deficit ($)','surplus']
  ];

  let html = '<table><thead><tr>';

  baseCols.forEach(([label,key]) => {
    const cls = (key === 'netWorth') ? 'networth-col' : '';
    html += `<th${cls ? ` class="${cls}"` : ''}>${label}</th>`;
  });

  propNames.forEach((name, i) => {
    const pLabel = `P${i+1}`;
    html += `<th>${pLabel} Value</th>`;
    html += `<th>${pLabel} Mortgage</th>`;
    html += `<th>${pLabel} Income</th>`;
    html += `<th>${pLabel} Expenses</th>`;
    html += `<th>${pLabel} CF</th>`;
  });

  html += '</tr></thead><tbody>';

  let dividerInserted = false;

  path.forEach(row => {
    if (!dividerInserted && row.surplus >= 0) {
      html += `<tr class="section-divider"><td colspan="${baseCols.length + propNames.length*5}">Cashflow Meets Spending (Modeled)</td></tr>`;
      dividerInserted = true;
    }

    html += '<tr>';

    baseCols.forEach(([label,key]) => {
      const cls = (key === 'netWorth') ? 'networth-col' : '';
      const val = row[key];
      if (key === 'year' || key === 'age') {
        html += `<td${cls ? ` class="${cls}"` : ''}>${val}</td>`;
      } else {
        html += `<td${cls ? ` class="${cls}"` : ''}>$${Number(val).toLocaleString()}</td>`;
      }
    });

    row.perProp.forEach(p => {
      html += `<td>$${Number(p.value).toLocaleString()}</td>`;
      html += `<td>$${Number(p.balance).toLocaleString()}</td>`;
      html += `<td>$${Number(p.grossIncome).toLocaleString()}</td>`;
      html += `<td>$${Number((p.operatingExp + p.mortgagePaid)).toLocaleString()}</td>`;
      html += `<td>$${Number(p.netCashflow).toLocaleString()}</td>`;
    });

    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderBitcoinTable(btcPath, container){
  if(!btcPath || !btcPath.length) return;

  let html = `<div class="section-title" style="margin-top:26px;">Bitcoin Alternative (What-If)</div>`;
  html += `<div class="subtle">This is a simple compounding comparison using your selected Bitcoin CAGR.</div>`;
  html += '<table><thead><tr>';
  html += `<th>Year</th><th>Age</th><th class="btc-col">Bitcoin Value ($)</th>`;
  html += '</tr></thead><tbody>';

  btcPath.forEach(r => {
    html += `<tr><td>${r.year}</td><td>${r.age}</td><td class="btc-col">$${Number(r.btcValue).toLocaleString()}</td></tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderPropertyYear1Summary(rows, container){
  if(!rows || !rows.length) return;

  let html = `<div class="section-title" style="margin-top:26px;">Property Snapshot (Today’s Year)</div>`;
  html += `<div class="subtle">Quick view of which properties are profitable *right now* (gross income − expenses − mortgage).</div>`;

  html += `<table><thead><tr>
    <th>Property</th>
    <th>Value</th>
    <th>Mortgage</th>
    <th>Equity</th>
    <th>Gross Income</th>
    <th>OpEx</th>
    <th>Mortgage Paid</th>
    <th>Net Cashflow</th>
  </tr></thead><tbody>`;

  rows.forEach(p => {
    html += `<tr>
      <td style="text-align:left;">${escapeHtml(p.name)}</td>
      <td>$${Number(p.value).toLocaleString()}</td>
      <td>$${Number(p.balance).toLocaleString()}</td>
      <td>$${Number(p.equity).toLocaleString()}</td>
      <td>$${Number(p.grossIncome).toLocaleString()}</td>
      <td>$${Number(p.operatingExp).toLocaleString()}</td>
      <td>$${Number(p.mortgagePaid).toLocaleString()}</td>
      <td>$${Number(p.netCashflow).toLocaleString()}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}

function escapeHtml(str){
  return (str || '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function drawChart(projection){
  if(!projection || !projection.path || !projection.path.length) return;

  const chartContainer = document.getElementById('chartContainer');
  chartContainer.style.display = 'block';

  const ctx = document.getElementById('netWorthChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();

  const labels = projection.path.map(r => r.year);
  const netWorth = projection.path.map(r => r.netWorth);
  const equity = projection.path.map(r => r.totalEquity);
  const cashflow = projection.path.map(r => r.totalNetCashflow);
  const spending = projection.path.map(r => r.spending);

  chartInstance = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'Net Worth ($)', data: netWorth, borderWidth:2, fill:false, borderColor:'skyblue' },
        { label:'Total Equity ($)', data: equity, borderWidth:1, fill:false, borderColor:'mediumpurple' },
        { label:'Net Rental Cashflow ($/yr)', data: cashflow, borderWidth:1, fill:false, borderColor:'orange' },
        { label:'Spending ($/yr)', data: spending, borderWidth:1, fill:false, borderColor:'lightcoral' },
      ]
    },
    options:{
      responsive:true,
      interaction:{ mode:'index', intersect:false },
      scales:{
        y:{ ticks:{ callback: v => '$' + Number(v).toLocaleString() } }
      },
      plugins:{
        tooltip:{ callbacks:{ label: (ctx) => `${ctx.dataset.label}: $${Number(ctx.parsed.y).toLocaleString()}` } }
      }
    }
  });
}

function exportCSV(projection){
  if(!projection || !projection.path || !projection.path.length) return;

  const rows = projection.path;
  const propCount = rows[0].perProp.length;

  const headers = [
    'Year','Age','NetWorth','TotalPropValue','TotalMortgage','TotalEquity',
    'TotalRentalGross','TotalOpEx','TotalMortgagePaid','TotalNetCashflow','OtherIncome','Spending','Surplus'
  ];

  for(let i=1;i<=propCount;i++){
    headers.push(`P${i}_Value`);
    headers.push(`P${i}_Mortgage`);
    headers.push(`P${i}_Income`);
    headers.push(`P${i}_Expenses`);
    headers.push(`P${i}_Cashflow`);
  }

  const lines = [headers.join(',')];

  rows.forEach(r => {
    const base = [
      r.year,
      r.age,
      Math.round(r.netWorth),
      Math.round(r.totalPropValue),
      Math.round(r.totalMortgageBalance),
      Math.round(r.totalEquity),
      Math.round(r.totalGrossIncome),
      Math.round(r.totalOperatingExp),
      Math.round(r.totalMortgagePaid),
      Math.round(r.totalNetCashflow),
      Math.round(r.otherIncome),
      Math.round(r.spending),
      Math.round(r.surplus)
    ];

    const propParts = [];
    r.perProp.forEach(p => {
      propParts.push(Math.round(p.value));
      propParts.push(Math.round(p.balance));
      propParts.push(Math.round(p.grossIncome));
      propParts.push(Math.round(p.operatingExp + p.mortgagePaid));
      propParts.push(Math.round(p.netCashflow));
    });

    lines.push([...base, ...propParts].join(','));
  });

  const blob = new Blob([lines.join('\n')], { type:'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'landlord_projection.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
