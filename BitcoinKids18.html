<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bitcoin 18 Fund Calculator — Bitcoin for Kids</title>
<style>
 * { box-sizing: border-box; }
 body {
   font-family: "Helvetica Neue", Arial, sans-serif;
   background:#f9fafb;
   color:#1a1a1a;
   margin:0;
 }
 header {
   background:#111;
   color:#f9fafb;
   padding:1.6rem 1rem;
   text-align:center;
   box-shadow:0 2px 8px rgba(0,0,0,.3);
 }
 header h1 { margin:0 0 .25rem; font-size:2rem; }
 header p { margin:0; opacity:.9; }

 main { max-width:1100px; margin:2rem auto; padding:0 20px; }
 .calculator { background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
 .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:14px; }
 .form-group { display:flex; flex-direction:column; }
 label { font-weight:600; color:#333; margin-bottom:6px; }
 input[type="number"], input[type="text"], select {
   padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; background:#fff;
 }
 .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
 button {
   border:0; padding:12px 16px; border-radius:8px; cursor:pointer; font-size:15px; font-weight:700;
 }
 .btn-primary { background:#f7931a; color:#fff; width:100%; margin-top:8px; }
 .btn-primary:hover { background:#e07c12; }
 .btn-secondary { background:#007bff; color:#fff; }
 .btn-secondary:hover { background:#0056b3; }
 .btn-muted { background:#6c757d; color:#fff; }
 .btn-muted:hover { background:#5a6268; }
 .small { font-size:12px; color:#666; }

 #result, #error { margin-top:16px; }
 #result { display:none; background:#e9ecef; padding:14px; border-radius:8px; }
 #error { color:#c62828; }

 #chartContainer { display:none; margin-top:20px; }
 canvas { max-width:100%; }

 table { width:100%; border-collapse:collapse; margin-top:18px; background:#fff; }
 th, td { text-align:right; padding:8px; border-bottom:1px solid #eee; }
 th { background:#f8f9fa; position:sticky; top:0; }
 td:first-child, th:first-child { text-align:left; }

 .note { font-size:13px; color:#666; margin-top:6px; }
 footer { text-align:center; padding:1.5rem; color:#666; margin-top:18px; }
 .small-tag { font-size:12px; color:#444; background: #fff3cd; padding:6px 8px; border-radius:6px; display:inline-block; margin-top:6px; }
</style>
</head>
<body>
 <header>
   <h1>Bitcoin for Kids — 18 Fund Calculator</h1>
   <p>Project a Bitcoin fund for a child that grows until their 18th birthday (lump-sum + DCA). Uses current BTC price from CoinGecko.</p>
 </header>

 <main>
   <div class="calculator">
     <div class="grid">
       <div class="form-group">
         <label for="childAge">Child's Current Age (years)</label>
         <input type="number" id="childAge" min="0" max="100" step="1" value="5">
       </div>

       <div class="form-group">
         <label for="lumpSum">Lump Sum to Invest Today ($)</label>
         <input type="number" id="lumpSum" min="0" step="1" value="1000">
       </div>

       <div class="form-group">
         <label for="monthlyDca">Monthly DCA Amount ($/month)</label>
         <input type="number" id="monthlyDca" min="0" step="1" value="50">
       </div>

       <div class="form-group">
         <label for="btcCagr">Bitcoin CAGR (% / year)</label>
         <input type="number" id="btcCagr" min="-100" max="1000" step="0.1" value="35">
         <div id="cagrNote" class="small"></div>
       </div>

       <div class="form-group">
         <label for="compareFiat">Compare to fiat savings?</label>
         <select id="compareFiat">
           <option value="none">No comparison</option>
           <option value="3">Yes — 3% yearly (typical savings)</option>
           <option value="5">Yes — 5% yearly</option>
         </select>
         <div class="small">If selected, shows a fiat savings growth for same contributions.</div>
       </div>

       <div class="form-group">
         <label for="targetUse">Planned Use at 18</label>
         <input type="text" id="targetUse" placeholder="e.g., college, rent, life expenses" value="College tuition">
       </div>

       <div class="form-group">
         <label>Current Bitcoin Price (USD)</label>
         <div id="btcPriceDisplay" class="small">Fetching current price…</div>
       </div>
     </div>

     <div class="btn-row">
       <button class="btn-primary" id="calcBtn">Calculate Plan</button>
       <button class="btn-secondary" id="chartBtn" style="display:none">Show Chart</button>
       <button class="btn-muted" id="resetBtn">Reset</button>
     </div>

     <div class="note">
       <div class="small-tag" id="horizonTag"></div>
       <div style="margin-top:8px;" class="small">CAGR guidance: &lt;10% = extremely conservative; 10–20% = conservative; 20–30% = moderate; 30–40% = bullish; &gt;40% = extremely bullish.</div>
     </div>

     <div id="error"></div>
     <div id="result"></div>

     <div id="chartContainer">
       <canvas id="btcKidChart"></canvas>
     </div>

     <div id="tableContainer"></div>
   </div>
 </main>

 <footer>
   <p>&copy; 2025 The Bitcoiner's Calculators</p>
 </footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
/*
 Bitcoin for Kids — 18 Fund Calculator
 - Fetches current BTC price from CoinGecko
 - Simulates monthly buys using a straight-line CAGR price path
 - Outputs BTC amount, final USD value at age 18, total invested, profit, and a year-by-year table + chart
*/

const el = id => document.getElementById(id);
const money = v => '$' + Number(v).toLocaleString(undefined,{maximumFractionDigits:0});
let chartInstance = null;
let currentBtcPrice = null;
const COINGECKO_URL = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd';

function fetchCurrentBtcPrice() {
  el('btcPriceDisplay').textContent = 'Fetching current price…';
  fetch(COINGECKO_URL)
    .then(r => r.json())
    .then(data => {
      if (data && data.bitcoin && data.bitcoin.usd) {
        currentBtcPrice = Number(data.bitcoin.usd);
        el('btcPriceDisplay').textContent = money(currentBtcPrice) + ' per BTC (CoinGecko)';
      } else {
        throw new Error('Unexpected response');
      }
    })
    .catch(err => {
      console.error('CoinGecko fetch error', err);
      el('btcPriceDisplay').textContent = 'Unable to fetch price. You can still calculate by entering a price manually below.';
      // leave currentBtcPrice as null; but allow user calculation
    });
}

// Update CAGR guidance note
function updateCagrNote() {
  const cagr = Number(el('btcCagr').value || 0);
  const note = el('cagrNote');
  let text = '';
  if (cagr < 10) text = 'Extremely conservative';
  else if (cagr < 20) text = 'Conservative';
  else if (cagr < 30) text = 'Moderate';
  else if (cagr < 40) text = 'Bullish';
  else text = 'Extremely bullish';
  note.textContent = `Entered CAGR: ${cagr}% — ${text}`;
}

function inputs() {
  return {
    childAge: Math.max(0, Number(el('childAge').value || 0)),
    lumpSum: Number(el('lumpSum').value || 0),
    monthlyDca: Number(el('monthlyDca').value || 0),
    btcCagr: Number(el('btcCagr').value || 0) / 100,
    compareFiat: el('compareFiat').value, // 'none' or y%
    targetUse: el('targetUse').value || 'Expense at 18'
  };
}

// Simulate monthly buying until child's 18th birthday
function simulateTo18() {
  const i = inputs();
  const result = { error: null };

  const yearsToGrow = Math.max(0, 18 - i.childAge);
  const totalMonths = Math.max(0, Math.round(yearsToGrow * 12));

  if (i.childAge >= 100) {
    result.error = 'Please enter a realistic child age.';
    return result;
  }

  // Starting price: use fetched CoinGecko price if available
  const startPrice = currentBtcPrice || 0;
  if (!startPrice || startPrice <= 0) {
    // If coinGecko failed, we still allow calculation but require user to have filled price manually.
    // For this implementation we'll error if price not available to avoid nonsense projections.
    result.error = 'Current BTC price not available from CoinGecko. Please ensure your browser can reach api.coingecko.com or try again.';
    return result;
  }

  // monthly growth rate implied by yearly CAGR
  const monthlyGrowth = Math.pow(1 + i.btcCagr, 1/12) - 1;

  // Precompute price path for each month: price_m = startPrice * (1 + monthlyGrowth)^m
  // Month 0 = today (m=0)
  const monthlyPrices = [];
  for (let m = 0; m <= totalMonths; m++) {
    monthlyPrices.push(startPrice * Math.pow(1 + monthlyGrowth, m));
  }

  // Lump-sum buy today at price0
  const btcFromLump = i.lumpSum > 0 ? (i.lumpSum / monthlyPrices[0]) : 0;

  // DCA: buy at the start of each month m = 0..totalMonths-1 (if totalMonths==0 no monthly buys)
  let btcFromDca = 0;
  let totalInvested = i.lumpSum;
  const dcaBuys = []; // keep for table
  for (let m = 0; m < totalMonths; m++) {
    const priceAtM = monthlyPrices[m];
    const invested = i.monthlyDca;
    totalInvested += invested;
    const btcBought = invested > 0 ? (invested / priceAtM) : 0;
    btcFromDca += btcBought;
    dcaBuys.push({ monthIndex: m, price: priceAtM, invested, btcBought });
  }

  const totalBtc = btcFromLump + btcFromDca;

  // Final price at maturity (end of period)
  const finalPrice = monthlyPrices[totalMonths] || monthlyPrices[0];

  const finalValueUsd = totalBtc * finalPrice;
  const profit = finalValueUsd - totalInvested;

  // Yearly aggregation for table/chart
  const years = [];
  const yearTotalsUsd = [];
  const btcHoldingsByYear = [];
  const investedByYear = [];
  // For each year y = 0..yearsToGrow, compute cumulative invested and BTC and value at year-end price
  let cumulativeInvested = i.lumpSum;
  let cumulativeBtc = btcFromLump; // we'll add monthly buys as we pass them
  for (let y = 0; y <= yearsToGrow; y++) {
    const monthsTill = y * 12; // months after start
    // Add DCA buys for months < monthsTill
    let btcAddedThisYear = 0;
    let investedThisYear = 0;
    for (let m = (y === 0 ? 0 : ( (y-1)*12 )) ; m < Math.min(monthsTill, totalMonths); m++) {
      // careful: ensure we don't double count; simpler: rebuild cumulatives each year
    }
    // Rebuild cumulatives up to monthsTill
    cumulativeInvested = i.lumpSum;
    cumulativeBtc = btcFromLump;
    for (let m = 0; m < Math.min(monthsTill, totalMonths); m++) {
      cumulativeInvested += i.monthlyDca;
      cumulativeBtc += (i.monthlyDca / monthlyPrices[m]);
    }
    const priceAtYear = monthlyPrices[Math.min(monthsTill, totalMonths)];
    const valUsd = cumulativeBtc * priceAtYear;
    years.push('Age ' + (i.childAge + y));
    yearTotalsUsd.push(Math.round(valUsd));
    btcHoldingsByYear.push(Number(cumulativeBtc.toFixed(8)));
    investedByYear.push(Math.round(cumulativeInvested));
  }

  result.totalMonths = totalMonths;
  result.yearsToGrow = yearsToGrow;
  result.startPrice = startPrice;
  result.monthlyPrices = monthlyPrices;
  result.monthlyGrowth = monthlyGrowth;
  result.btcFromLump = btcFromLump;
  result.btcFromDca = btcFromDca;
  result.totalBtc = totalBtc;
  result.finalPrice = finalPrice;
  result.finalValueUsd = finalValueUsd;
  result.totalInvested = totalInvested;
  result.profit = profit;
  result.dcaBuys = dcaBuys;
  result.years = years;
  result.yearTotalsUsd = yearTotalsUsd;
  result.btcHoldingsByYear = btcHoldingsByYear;
  result.investedByYear = investedByYear;
  result.inputs = i;

  // If fiat comparison requested, compute fiat growth
  if (i.compareFiat !== 'none') {
    const fiatRate = Number(i.compareFiat) / 100;
    // monthly fiat growth
    const fiatMonthly = Math.pow(1 + fiatRate, 1/12) - 1;
    let fiatValue = i.lumpSum;
    // DCA into fiat each month and grow
    for (let m = 0; m < totalMonths; m++) {
      fiatValue = (fiatValue * (1 + fiatMonthly)) + i.monthlyDca;
    }
    result.fiatValue = fiatValue;
    result.fiatProfit = fiatValue - result.totalInvested;
  }

  return result;
}

function renderSummary(sim) {
  if (!sim) return;
  const i = sim.inputs;
  const lastAge = i.childAge + sim.yearsToGrow;
  const rows = sim.years.length;

  let winnerHtml = '';
  if (sim.fiatValue) {
    if (sim.finalValueUsd > sim.fiatValue) winnerHtml = `<div style="font-weight:bold; background-color:yellow; font-size:1.6em; margin-top:10px; padding:5px; text-align:center;">Bitcoin outperforms fiat by ${money(Math.round(sim.finalValueUsd - sim.fiatValue))}</div>`;
    else winnerHtml = `<div style="font-weight:bold; background-color:#d1ecf1; font-size:1.3em; margin-top:10px; padding:5px; text-align:center;">Fiat savings outperforms by ${money(Math.round(sim.fiatValue - sim.finalValueUsd))}</div>`;
  }

  const html = `
    <div><strong>Child's age at start:</strong> ${i.childAge} years</div>
    <div style="margin-top:6px;"><strong>Investment horizon:</strong> ${sim.yearsToGrow} years (to age ${lastAge}).</div>
    <div style="margin-top:8px;"><strong>Total Invested:</strong> <strong>${money(Math.round(sim.totalInvested))}</strong> (Lump: ${money(sim.inputs.lumpSum)}, DCA total: ${money(Math.round(sim.totalInvested - sim.inputs.lumpSum))}).</div>
    <div style="margin-top:6px;"><strong>BTC accumulated:</strong> <strong>${Number(sim.totalBtc.toFixed(8))} BTC</strong> (Lump: ${Number(sim.btcFromLump.toFixed(8))} BTC, DCA: ${Number(sim.btcFromDca.toFixed(8))} BTC).</div>
    <div style="margin-top:6px;"><strong>Projected BTC price at age ${lastAge}:</strong> <strong>${money(Math.round(sim.finalPrice))}</strong> (CAGR: ${(sim.inputs.btcCagr*100).toFixed(2)}%/yr).</div>
    <div style="margin-top:8px;"><strong>Projected Value at ${lastAge}:</strong> <strong>${money(Math.round(sim.finalValueUsd))}</strong>.</div>
    <div style="margin-top:6px;"><strong>Projected Profit:</strong> <strong>${money(Math.round(sim.profit))}</strong>.</div>
    ${sim.fiatValue ? `<div style="margin-top:8px;"><strong>Fiat comparison value:</strong> <strong>${money(Math.round(sim.fiatValue))}</strong> (profit: ${money(Math.round(sim.fiatProfit))}).</div>` : ''}
    ${winnerHtml}
    <div class="small" style="margin-top:8px;">Note: Price path uses a straight-line CAGR projection (monthly compounding) — this is a simple projection, not a forecast. DCA purchases are simulated at each month's projected price for accuracy.</div>
  `;
  el('result').innerHTML = html;
  el('result').style.display = 'block';
}

function renderTable(sim) {
  if (!sim) return;
  const tYears = sim.years;
  if (!tYears.length) return;
  let html = `
    <table>
      <thead>
        <tr>
          <th>Year (Age)</th>
          <th>Portfolio Value ($)</th>
          <th>BTC Holdings</th>
          <th>Total Invested ($)</th>
        </tr>
      </thead>
      <tbody>
  `;
  for (let idx = 0; idx < tYears.length; idx++) {
    html += `
      <tr>
        <td>${tYears[idx]}</td>
        <td>${money(sim.yearTotalsUsd[idx])}</td>
        <td>${sim.btcHoldingsByYear[idx].toFixed(8)}</td>
        <td>${money(sim.investedByYear[idx])}</td>
      </tr>
    `;
  }
  html += `</tbody></table>`;
  el('tableContainer').innerHTML = html;
}

function renderChart(sim) {
  const ctx = el('btcKidChart').getContext('2d');
  el('chartContainer').style.display = 'block';
  if (chartInstance) chartInstance.destroy();

  const labels = sim.years;
  const dataValues = sim.yearTotalsUsd;
  const invested = sim.investedByYear;

  const datasets = [
    {
      label: 'Projected Portfolio Value ($)',
      data: dataValues,
      borderWidth: 2,
      borderColor: '#f7931a',
      backgroundColor: 'transparent',
      fill: false,
      tension: 0.2
    },
    {
      label: 'Total Invested ($)',
      data: invested,
      borderWidth: 2,
      borderColor: '#007bff',
      backgroundColor: 'transparent',
      fill: false,
      tension: 0.2
    }
  ];

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: { ticks: { callback: v => '$' + Number(v).toLocaleString() } }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: $${Number(ctx.parsed.y).toLocaleString()}` } }
      }
    }
  });
}

// Main calculate action
function calculate() {
  el('error').textContent = '';
  el('result').style.display = 'none';
  el('tableContainer').innerHTML = '';
  el('chartContainer').style.display = 'none';
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  updateCagrNote();

  const sim = simulateTo18();
  if (sim.error) {
    el('error').textContent = sim.error;
    return;
  }

  // horizon tag
  const horizonText = sim.yearsToGrow === 0 ? 'Child is 18 or older — immediate value shown.' : `Projected horizon: ${sim.yearsToGrow} years (to age ${Number(el('childAge').value)+sim.yearsToGrow})`;
  el('horizonTag').textContent = horizonText;

  renderSummary(sim);
  renderTable(sim);
  el('chartBtn').style.display = 'inline-block';

  // store sim for chart button
  window._lastSim = sim;
}

// Reset to defaults similar style to your other page
function resetAll() {
  el('childAge').value = 5;
  el('lumpSum').value = 1000;
  el('monthlyDca').value = 50;
  el('btcCagr').value = 35;
  el('compareFiat').value = 'none';
  el('targetUse').value = 'College tuition';
  el('result').style.display = 'none';
  el('tableContainer').innerHTML = '';
  el('chartContainer').style.display = 'none';
  el('error').textContent = '';
  el('chartBtn').style.display = 'none';
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  updateCagrNote();
  el('horizonTag').textContent = '';
}

el('calcBtn').addEventListener('click', (e) => { e.preventDefault(); calculate(); });
el('chartBtn').addEventListener('click', (e) => { e.preventDefault(); if (window._lastSim) renderChart(window._lastSim); });
el('resetBtn').addEventListener('click', (e) => { e.preventDefault(); resetAll(); });

el('btcCagr').addEventListener('input', updateCagrNote);
el('childAge').addEventListener('input', () => { const v = Number(el('childAge').value || 0); if (v < 0) el('childAge').value = 0; });
el('lumpSum').addEventListener('input', () => {});
el('monthlyDca').addEventListener('input', () => {});

// Initial setup
updateCagrNote();
fetchCurrentBtcPrice();

</script>
</body>
</html>
