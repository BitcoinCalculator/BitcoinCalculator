<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Retire Early with Bitcoin — Earliest Retirement Finder</title>
<style>
  /* Theme aligned with main index page */
  * { box-sizing: border-box; }
  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    background:#f9fafb;
    color:#1a1a1a;
    margin:0;
  }
  header {
    background:#111;
    color:#f9fafb;
    padding:1.6rem 1rem;
    text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,.3);
  }
  header h1 { margin:0 0 .25rem; font-size:2rem; }
  header p { margin:0; opacity:.9; }

  main { max-width:1100px; margin:2rem auto; padding:0 20px; }

  .calculator { background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.08);}
  .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:14px;}
  .form-group { display:flex; flex-direction:column; }
  label { font-weight:600; color:#333; margin-bottom:6px;}
  input[type="number"], select {
    padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; background:#fff;
  }
  .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  button {
    border:0; padding:12px 16px; border-radius:8px; cursor:pointer; font-size:15px; font-weight:700;
  }
  #findButton { background:#f7931a; color:#fff; width:100%; margin-top:8px; }
  #findButton:hover { background:#e07c12; }
  #chartButton { background:#007bff; color:#fff; }
  #chartButton:hover { background:#0056b3; }
  #exportButton { background:#6c757d; color:#fff; }
  #exportButton:hover { background:#5a6268; }

  #result, #error { margin-top:16px; }
  #result { display:none; background:#e9ecef; padding:14px; border-radius:8px;}
  #error { color:#c62828; }

  #chartContainer { display:none; margin-top:20px; }
  canvas { max-width:100%; }

  table { width:100%; border-collapse:collapse; margin-top:18px; background:#fff; }
  th, td { text-align:right; padding:8px; border-bottom:1px solid #eee;}
  th { background:#f8f9fa; position:sticky; top:0; }
  td:first-child, th:first-child { text-align:left; }

  .note { font-size:13px; color:#666; margin-top:6px;}
  footer { text-align:center; padding:1.5rem; color:#666; }
</style>
</head>
<body>
  <header>
    <h1>Retire Early with Bitcoin</h1>
    <p>Find the earliest age you can retire while drawing down smartly across assets.</p>
  </header>

  <main>
    <div class="calculator">
      <div class="grid">
        <div class="form-group">
          <label for="age">Current Age (years)</label>
          <input type="number" id="age" min="0" max="100" step="0.5" required>
        </div>
        <div class="form-group">
          <label for="lifeExpectancy">Plan To Age (life expectancy)</label>
          <input type="number" id="lifeExpectancy" min="60" max="120" step="1" value="95" required>
        </div>
        <div class="form-group">
          <label for="income">Yearly Income ($)</label>
          <input type="number" id="income" min="0" step="100" required>
        </div>
        <div class="form-group">
          <label for="savingsRate">Savings Rate (% of income)</label>
          <input type="number" id="savingsRate" min="0" max="100" step="0.1" required>
        </div>

        <!-- Savings destination -->
        <div class="form-group">
          <label for="savingsDestination">Where Do Savings Go?</label>
          <select id="savingsDestination">
            <option value="investments">Investments</option>
            <option value="otherAssets">Other Investments</option>
            <option value="bitcoin">Bitcoin</option>
          </select>
        </div>

        <!-- Bitcoin inputs -->
        <div class="form-group">
          <label for="bitcoin">Bitcoin Holdings (BTC)</label>
          <input type="number" id="bitcoin" min="0" step="0.00000001" value="0">
        </div>
        <div class="form-group">
          <label for="btcPrice">Current BTC Price ($)</label>
          <input type="number" id="btcPrice" min="0" step="100">         
        </div>
        <div class="form-group">
          <label for="btcCagr">Bitcoin CAGR (%)</label>
          <input type="number" id="btcCagr" min="-100" max="500" step="0.1" value="30">
        </div>

        <div class="form-group">
          <label for="investments">Current Investments ($) — liquid/taxable</label>
          <input type="number" id="investments" min="0" step="100" required>
        </div>
        <div class="form-group">
          <label for="investmentCagr">Investments CAGR (%)</label>
          <input type="number" id="investmentCagr" min="-100" max="100" step="0.1" required>
        </div>

        <div class="form-group">
          <label for="otherAssets">Other Liquid Assets ($)</label>
          <input type="number" id="otherAssets" min="0" step="100" required>
        </div>
        <div class="form-group">
          <label for="otherAssetsCagr">Other Assets CAGR (%)</label>
          <input type="number" id="otherAssetsCagr" min="-100" max="100" step="0.1" required>
        </div>

        <div class="form-group">
          <label for="k401Balance">401k Balance ($)</label>
          <input type="number" id="k401Balance" min="0" step="100" required>
        </div>
        <div class="form-group">
          <label for="k401Cagr">401k CAGR (%)</label>
          <input type="number" id="k401Cagr" min="-100" max="100" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="k401TaxRate">401k Tax Rate (%)</label>
          <input type="number" id="k401TaxRate" min="0" max="100" step="1" value="30">
        </div>

        <div class="form-group">
          <label for="realEstate">Real Estate Value ($) — non-liquid</label>
          <input type="number" id="realEstate" min="0" step="100" required>
        </div>
        <div class="form-group">
          <label for="realEstateCagr">Real Estate CAGR (%)</label>
          <input type="number" id="realEstateCagr" min="-100" max="100" step="0.1" required>
        </div>

        <div class="form-group">
          <label for="inflationRate">Expected Inflation Rate (%)</label>
          <input type="number" id="inflationRate" min="0" max="20" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="retirementSpending">Desired Annual Retirement Spending ($, today’s dollars)</label>
          <input type="number" id="retirementSpending" min="0" step="100" required>
        </div>
      </div>

      <div class="btn-row">
        <button id="findButton">Find Earliest Retirement</button>
        <button id="chartButton" style="display:none;">Show Net Worth Chart</button>
        <button id="exportButton" style="display:none;">Export Table (CSV)</button>
      </div>

      <div class="note">
        Rule set: Contributions (pre-retirement) go to your chosen bucket. During retirement, annual
        spending inflates from today, and withdrawals are taken from
        <strong>lowest CAGR → highest CAGR</strong>. 401k is available at <strong>age 59.5</strong> and
        withdrawals are taxed (default <strong>30%</strong>, adjustable). Real estate is not sold.
      </div>

      <div id="error"></div>
      <div id="result"></div>

      <div id="chartContainer">
        <canvas id="netWorthChart"></canvas>
      </div>

      <div id="tableContainer"></div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 The Bitcoiner's Calculators</p>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
let chartInstance = null;
let lastPath = [];

document.getElementById('findButton').addEventListener('click', (e) => {
  e.preventDefault();
  runFinder();
});
document.getElementById('chartButton').addEventListener('click', () => {
  drawChart(lastPath);
});
document.getElementById('exportButton').addEventListener('click', () => {
  exportCSV(lastPath);
});

function getInputs() {
  const v = id => document.getElementById(id).value;
  return {
    age: parseFloat(v('age')),
    lifeExpectancy: parseFloat(v('lifeExpectancy')),
    income: parseFloat(v('income')),
    savingsRate: parseFloat(v('savingsRate')) / 100,
    savingsDestination: v('savingsDestination'),

    bitcoinBTC: parseFloat(v('bitcoin')),
    btcPrice: parseFloat(v('btcPrice')),
    btcCagr: parseFloat(v('btcCagr')) / 100,

    investments: parseFloat(v('investments')),
    investmentCagr: parseFloat(v('investmentCagr')) / 100,

    otherAssets: parseFloat(v('otherAssets')),
    otherAssetsCagr: parseFloat(v('otherAssetsCagr')) / 100,

    k401Balance: parseFloat(v('k401Balance')),
    k401Cagr: parseFloat(v('k401Cagr')) / 100,
    k401TaxRate: parseFloat(v('k401TaxRate')) / 100,

    realEstate: parseFloat(v('realEstate')),
    realEstateCagr: parseFloat(v('realEstateCagr')) / 100,

    inflationRate: parseFloat(v('inflationRate')) / 100,
    retirementSpending: parseFloat(v('retirementSpending'))
  };
}

function validateInputs(i) {
  const err = [];
  if (isNaN(i.age) || i.age < 0 || i.age > 100) err.push('Age must be 0–100.');
  if (isNaN(i.lifeExpectancy) || i.lifeExpectancy <= i.age) err.push('Life expectancy must exceed current age.');
  if (isNaN(i.income) || i.income < 0) err.push('Income must be ≥ 0.');
  if (isNaN(i.savingsRate) || i.savingsRate < 0 || i.savingsRate > 1) err.push('Savings rate must be 0–100%.');

  const nums = ['investments','otherAssets','k401Balance','realEstate','retirementSpending','btcPrice','bitcoinBTC'];
  nums.forEach(k => { if (isNaN(i[k]) || i[k] < 0) err.push(`${labelize(k)} must be ≥ 0.`); });

  const pcts = ['investmentCagr','otherAssetsCagr','k401Cagr','realEstateCagr','inflationRate','btcCagr','k401TaxRate'];
  pcts.forEach(k => { if (isNaN(i[k])) err.push(`${labelize(k)} is required.`); });

  return err;
  function labelize(k){
    return k
      .replace(/([A-Z])/g,' $1')
      .replace('k401','401k')
      .replace('btc','BTC ')
      .replace(/^./,s=>s.toUpperCase())
      .trim();
  }
}

function runFinder() {
  const errorDiv = document.getElementById('error');
  const resultDiv = document.getElementById('result');
  const chartBtn = document.getElementById('chartButton');
  const exportBtn = document.getElementById('exportButton');
  const tableContainer = document.getElementById('tableContainer');

  errorDiv.textContent = '';
  resultDiv.style.display = 'none';
  chartBtn.style.display = 'none';
  exportBtn.style.display = 'none';
  tableContainer.innerHTML = '';
  document.getElementById('chartContainer').style.display = 'none';
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  const i = getInputs();
  const errs = validateInputs(i);
  if (errs.length) { errorDiv.textContent = errs.join(' '); return; }

  const maxYearsSearch = 50; // search window for retirement start
  let foundPlan = null;

  for (let startIn = 0; startIn <= maxYearsSearch; startIn++) {
    const sim = simulatePlan(i, startIn);
    if (sim.success) { foundPlan = { startIn, sim }; break; }
  }

  resultDiv.style.display = 'block';
  if (!foundPlan) {
    resultDiv.textContent = `❌ No feasible retirement found within ${maxYearsSearch} years under current assumptions. Try lowering spending, raising savings, or increasing returns.`;
    return;
  }

  const retireAge = (i.age + foundPlan.startIn).toFixed(1);
  resultDiv.innerHTML = `
    ✅ Earliest retirement age: <strong>${retireAge}</strong><br/>
    (Retire in <strong>${foundPlan.startIn} year(s)</strong> and your liquid assets never deplete through age ${i.lifeExpectancy}.)`;

  lastPath = foundPlan.sim.path; // store for chart/table/export
  exportBtn.style.display = 'inline-block';
  renderTable(lastPath, tableContainer);
    // Auto-show chart
  drawChart(lastPath);
}

function simulatePlan(i, startInYears) {
  // Initial balances (Bitcoin converted to USD)
  let inv = i.investments;
  let oth = i.otherAssets;
  let k401 = i.k401Balance;
  let re  = i.realEstate;
  let btc = (i.bitcoinBTC || 0) * (i.btcPrice || 0);

  const path = [];
  const startAge = i.age;
  const retireAge = i.age + startInYears;
  const maxAge = i.lifeExpectancy;

  const annualSavings = i.income * i.savingsRate;

  let yearIndex = 0;
  for (let age = startAge; age <= maxAge; age += 1, yearIndex += 1) {
    const isRetired = age >= retireAge;

    // 1) Contributions (only before retirement): add to selected bucket
    if (!isRetired && annualSavings > 0) {
      if (i.savingsDestination === 'bitcoin') btc += annualSavings;
      else if (i.savingsDestination === 'otherAssets') oth += annualSavings;
      else inv += annualSavings; // default investments
    }

    // 2) Grow all buckets annually by their CAGRs
    inv *= (1 + i.investmentCagr);
    oth *= (1 + i.otherAssetsCagr);
    k401 *= (1 + i.k401Cagr);
    re  *= (1 + i.realEstateCagr);
    btc *= (1 + i.btcCagr);

    // 3) If retired, withdraw to cover inflation-adjusted spending by lowest CAGR → highest
    let withdrawnInv = 0, withdrawnOth = 0, withdrawn401Gross = 0, withdrawnBtc = 0;
    let required = 0;

    if (isRetired) {
      // Spending inflated from TODAY (not from retirement start)
      required = i.retirementSpending * Math.pow(1 + i.inflationRate, yearIndex);
      let need = required;

      // Build dynamic bucket list with effective CAGR and withdraw logic
      const accessible401k = age >= 59.5;

      // Helper to push a bucket
      const buckets = [];

      buckets.push({
        name:'Investments',
        cagr:i.investmentCagr,
        netAvail: () => inv,
        take: (takeNet) => { const amt = Math.min(inv, takeNet); inv -= amt; withdrawnInv += amt; return amt; }
      });

      buckets.push({
        name:'Other',
        cagr:i.otherAssetsCagr,
        netAvail: () => oth,
        take: (takeNet) => { const amt = Math.min(oth, takeNet); oth -= amt; withdrawnOth += amt; return amt; }
      });

      if (accessible401k) {
        buckets.push({
          name:'401k',
          cagr:i.k401Cagr,
          netAvail: () => k401 * (1 - i.k401TaxRate), // net of tax spendable
          take: (takeNet) => {
            const maxNet = k401 * (1 - i.k401TaxRate);
            const net = Math.min(maxNet, takeNet);
            const gross = net / (1 - i.k401TaxRate);
            k401 -= gross;
            withdrawn401Gross += gross;
            return net;
          }
        });
      }

      buckets.push({
        name:'Bitcoin',
        cagr:i.btcCagr,
        netAvail: () => btc,
        take: (takeNet) => { const amt = Math.min(btc, takeNet); btc -= amt; withdrawnBtc += amt; return amt; }
      });

      // Sort by CAGR ascending: lowest growth first
      buckets.sort((a,b) => a.cagr - b.cagr);

      // Withdraw in order
      for (const b of buckets) {
        if (need <= 0) break;
        const canNet = b.netAvail();
        if (canNet <= 0) continue;
        const taken = b.take(need);
        need -= taken;
      }

      // If still need > 0, plan fails
      if (need > 0) {
        return { success: false, reason: 'insufficient_liquidity', atAge: age };
      }
    }

    // Record this year
    const netWorth = inv + oth + k401 + re + btc;
    path.push({
      age: +age.toFixed(1),
      invested: inv,
      other: oth,
      k401: k401,
      bitcoin: btc,
      realEstate: re,
      netWorth: netWorth,
      requiredSpending: +required.toFixed(2),
      withdrawnInv: +withdrawnInv.toFixed(2),
      withdrawnOther: +withdrawnOth.toFixed(2),
      withdrawn401k: +withdrawn401Gross.toFixed(2), // gross removed from 401k
      withdrawnBitcoin: +withdrawnBtc.toFixed(2),
      retired: isRetired
    });

    // Safety: none go negative
    if (inv < -1e-6 || oth < -1e-6 || k401 < -1e-6 || btc < -1e-6) {
      return { success: false, reason: 'negative_balance', atAge: age };
    }
  }

  // Success to life expectancy
  return { success: true, path };
}

function drawChart(path) {
  if (!path || !path.length) return;
  const ctx = document.getElementById('netWorthChart').getContext('2d');
  document.getElementById('chartContainer').style.display = 'block';
  if (chartInstance) { chartInstance.destroy(); }

  const labels = path.map(p => p.age);
  const net = path.map(p => p.netWorth);
  const inv = path.map(p => p.invested);
  const oth = path.map(p => p.other);
  const k4  = path.map(p => p.k401);
  const btc = path.map(p => p.bitcoin);
  const re  = path.map(p => p.realEstate);

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Net Worth ($)', data: net, borderWidth: 2, fill: false, borderColor: 'skyblue'},
        { label: 'Investments ($)', data: inv, borderWidth: 1, fill: false, borderColor: 'lightcoral'},
        { label: 'Other Assets ($)', data: oth, borderWidth: 1, fill: false, borderColor: 'mediumseagreen'},
        { label: '401k ($)', data: k4, borderWidth: 1, fill: false, borderColor: 'mediumpurple'},
        { label: 'Bitcoin ($)', data: btc, borderWidth: 1, fill: false, borderColor: 'orange' },
        { label: 'Real Estate ($)', data: re, borderWidth: 1, fill: false, borderColor: 'peru'},
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: {
          ticks: { callback: v => '$' + Number(v).toLocaleString() }
        }
      },
      plugins: {
        tooltip: {
          callbacks: { label: (ctx) => `${ctx.dataset.label}: $${Number(ctx.parsed.y).toLocaleString()}` }
        }
      }
    }
  });
}

function renderTable(path, container) {
  if (!path || !path.length) return;
  const cols = [
    ['Age','age'],
    ['Net Worth ($)','netWorth'],
    ['Investments ($)','invested'],
    ['Other Assets ($)','other'],
    ['401k ($)','k401'],
    ['Bitcoin ($)','bitcoin'],
    ['Real Estate ($)','realEstate'],
    ['Req. Spending ($)','requiredSpending'],
    ['From Inv ($)','withdrawnInv'],
    ['From Other ($)','withdrawnOther'],
    ['From 401k (gross $)','withdrawn401k'],
    ['From Bitcoin ($)','withdrawnBitcoin'],
    ['Retired?','retired']
  ];

  let html = '<table><thead><tr>';
  cols.forEach(c => html += `<th>${c[0]}</th>`);
  html += '</tr></thead><tbody>';

  path.forEach(row => {
    html += '<tr>';
    cols.forEach(([label,key]) => {
      let v = row[key];
      if (key === 'age') {
        html += `<td>${v}</td>`;
      } else if (key === 'retired') {
        html += `<td>${v ? 'Yes' : 'No'}</td>`;
      } else if (typeof v === 'number') {
        html += `<td>${'$' + Number(v).toLocaleString()}</td>`;
      } else {
        html += `<td>${v}</td>`;
      }
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function exportCSV(path) {
  if (!path || !path.length) return;
  const headers = [
    'Age','NetWorth','Investments','OtherAssets','401k','Bitcoin','RealEstate',
    'RequiredSpending','WithdrawnInvestments','WithdrawnOther','Withdrawn401kGross','WithdrawnBitcoin','Retired'
  ];
  const lines = [headers.join(',')];
  path.forEach(p => {
    lines.push([
      p.age,
      Math.round(p.netWorth),
      Math.round(p.invested),
      Math.round(p.other),
      Math.round(p.k401),
      Math.round(p.bitcoin),
      Math.round(p.realEstate),
      p.requiredSpending,
      p.withdrawnInv,
      p.withdrawnOther,
      p.withdrawn401k,
      p.withdrawnBitcoin,
      p.retired ? 'Yes' : 'No'
    ].join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'retirement_path.csv';
  a.click();
  URL.revokeObjectURL(url);
}
  // 🔥 New code to update BTC price
async function updateBTCPrice() {
  try {
    let res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
    let data = await res.json();
    let price = data.bitcoin.usd;
    document.getElementById("btcPrice").value = price;
  } catch (err) {
    console.error("BTC price fetch failed:", err);
  }
}

// Run once on page load
updateBTCPrice();
</script>
</body>
</html>
